# Practice Roadmap
Copyright (C) Viorel Contu 2019.

This application source code can only be used for educational purposes. 

## Table of Contents

1. [ Description ](#desc)
2. [ General Setup ](#setup)
    * [ Install ](#install)
    * [ Test ](#test)
    * [ Coin Market Cap ](#coin)
3. [ Running ](#run)
    * [ Spring Profiles ](#spring)
4. [ Usage ](#usage)
    * [ REST Endpoints ](#endpoints)
    * [ Swagger-UI ](#swagger)
    * [ Alternative Http Clients ](#httpclients)
5. [ Configuration ](#configuration)
6. [ Future Plans ](#future)
7. [ Recommended Links ](#recommendation)


<a name="desc"><a>
## 1. Description
This application serves as a road map to learning many technologies necessary to build and run a web service. It is build on spring boot. The app provides an example of using the following instruments:
- Spring Boot 
- Spring Web; Jackson, MapStruct; RestTemplate; Swagger 
- Spring Data; Hibernate; H2; Oracle
- JUnit Jupiter; AssertJ; Mockito; RestAssured
- Lombok
- Logback

The application connects to [CoinMarketCap](https://coinmarketcap.com/) Api to retrieve cryptocurrency price quotes and share this information through a selection of REST endpoints. Please, see how to configure application to access CoinMarketCap [here](#coin).


<a name="setup"><a>
## 2. General Setup
Project requires Apache Maven to be installed on machine.

<a name="install"><a>
### 2.1 Install

The application can configured to run either on
* H2 in memory database (default behaviour)
* Oracle database instance

Switching from H2 to Oracle is done by using the Maven Profiles. 

#### 2.1.1 Install with H2
`mvn clean install` will compile and install the application with application configured to run on H2. 
The database schema will be autogenerated 

#### 2.1.2 Install with Oracle 
`mvn clean install -P oracle` will compile and install the application and configure it to connect to an oracle db.

The db credentials for connecting to oracle can be changed in either maven pom.xml:
```xml
<properties>
    <db.user>USERNAME</db.user>
    <db.password>PASSWORD</db.password>
    <db.url>jdbc:oracle:thin:@//localhost:1521/orclpdb</db.url>
</properties>
``` 
These properties can be changed through command line parameters: 
`mvn -P oracle -Ddb.user=USERNAME -Ddb.password=PASSWORD clean install`

#### 2.1.3 Oracle DB Flyway Migration
The same credentials for connecting to Oracle DB will be used for flyway oracle migration.
Flyway plugin, together with Oracle JDBC drivers should be accessed through **oracle maven profile** 

To use flyway migration: `mvn -P oracle flyway:clean flyway:migrate`

<a name="test"><a>
### 2.2 Test
`mvn clean test` to run unit tests

`mvn clean verify -P run-its` to run integration tests

<a name="coin"><a>
### 2.3 Coin Market Cap
First of all, go to [CoinMarketCap Sandbox](https://sandbox.coinmarketcap.com) create free sandbox account and obtain an API key. The key should be inserted into config file:

* ***src/main/resources/application.properties***
```properties
crypto.portal.token=<Insert API Key here>
crypto.portal.host=https://sandbox-api.coinmarketcap.com
```
The application connects to Coin Market Sandbox. To connect to Coin Market production servers, you need a different production account. Change the property `crypto.portal.host` to point to the URL of the production server.   
 With a valid account on Coin Market either Sandbox or production, and valid API key for that account you can now use the **/quotes** endpoint and make HTTP REST calls to obtain market values for different crypto-currencies. 

<a name="run"><a>
## 3. Running
To start the application, while inside the code repository, you can use maven:
`mvn spring-boot:run` 

To execute the deployable jar: 
`java -jar roadmap-2.0.jar`

<a name="spring"><a>
### 3.1 Spring Profiles
While **Maven profiles** configure the application during installation, the **Spring profiles** define how the application actually runs.    

* ***dev*** profile: (Default: **active**) Activates all sort of debug and tracing tools
* ***security*** profile: (Default: **active**) Activates authentication and authorization for most of endpoints. Use http header api key to authenticate.
* ***h2*** profile: (Default: **active**) Runs in memory DB. Configured to start automatically when installing with maven `mvn clean install`
* ***oracle*** profile: Connects to Oracle DB, overrides h2 profile. Configured to start automatically when installed with maven `mvn clean install -P oracle` 


The spring profiles are configured using maven profiles. When running maven with a profile, it makes changes into
* ***application.properties
```properties
spring.profiles.active=dev,security
spring.profiles.include=@spring.database.profile@
```
The maven resource plugin replaces the placeholder property *@spring.database.profile@* with either h2 or oracle depending on the installation arguments. 


#### 3.1.1 Spring dev profile
The spring **dev** profile activates all sort of debugs and traces:
* hibernate SQL queries
* transaction management messages  
* swagger ui endpoint

**dev** is activated by default in: 
* ***src/main/resources/application.properties***


#### 3.1.2 Default H2 in memory database
H2 is activated for the application when compiled with maven default profile. Before running please ensure that you have compiled it with the right maven profile.


#### 3.1.3 Oracle database
Spring **oracle** profile will use the jdbc drivers installed and everything else configured by maven to connect to Oracle DB
You need to create a user in your Oracle DB in order to be able to migrate the data. 
Connect to sys user and issue the following commands:

* `create user roadmap identified by password`
* `grant create connection, create table, create view, create sequence to roadmap`
* `grant unlimitted tablespace to roadmap`

Consult Oracle reference manual for extra configuration.

#### 3.1.4 Switching Spring profiles
The spring **h2**/**oracle** profiles will be activated automatically depending how you compiled with maven.

The **dev** profile can be turned on and off manually by either: 
  
* Editing the *application.properties* config
* InteliJ IDEA: 
    1. **CTRL+SHIFT+A**
    2. Type `edit configurations`<ENTER>
    3. Select in right column **Spring Boot** -> **RoadmapApplication** 
    4. **Configuration Tab** -> Section **Spring Boot**
    5. Edit **Active Profiles** field with **prod** profile
    6. Run Roadmap Application from InteliJ IDEA
* From command line: `java -jar roadmap-2.0.jar -Dspring.profiles.active=dev`
* From command line with maven: `mvn spring-boot:run -Drun.arguments="--spring.profiles.active=dev"`


<a name="usage"><a>
## 4. Application Usage
<a name="endpoints"><a>
Application will only serve authenticated and authorized users. The required data is pulled from database. 

<a name="authentication"><a>
### 4.1 Authentication (Error: HttpStatus 401 Unauthorized)
To make calls you need, to include in request Header your api key. Consult the migration scripts located in 

* `src/main/resources/db/migration` for the user tokens to identify yourself as that specific user. 

example: `X-API-KEY: 12345678-1234-1234-1234-111111122211`

<a name="authorization"><a>
### 4.2 Authorization (Error: HttpStatus 403 Unauthenticated)
Different api calls require different user roles. Please consult the migration scripts to select a user authorized to make a specific call. 

<a name="endpoints"><a>
### 4.3 REST Endpoints
* `/users`  performs different CRUD operations on users
* `/map`    maps the ids and symbols for crypto-currencies and normal currencies used by app    
* `/quotes` retrieves market quotes for selected crypto-currencies

<a name="swagger"><a>
### 4.3 Swagger-UI
You can inspect REST endpoints with Swagger UI: [http://localhost:8080/api/swagger/](http://localhost:8080/api/swagger/)

Following api specifications are available (select through combobox upper right):
* open-api - custom specification written manually (more detailed, with examples)
* default - automatically generated by swagger based on class definitions

The custom api file location is defined in properties:
```properties
swagger.custom-api=/api/roadmap-api.yml
```

<a name="httpclients"><a>
### 4.4 Alternative HTTP Clients
* ***src/test/resources/http/*** 

contains http template files:
- users.http
- map.http
- quotes.http

You can invoke the HTTP requests in these files directly from InteliJ IDEA.


<a name="configuration"><a>
## 5. Configuration 
No other configuration is necessary. 

For testing purposes, a different sql file is loaded, located in
 * ***src/test/resources/db/test-data.sql***


<a name="future"><a>
## 6. Future Plans
- [X] Add exception handler for RestTemplate
- [X] Generate custom API schema for Swagger
- [X] Upgrade to a normal SQL DB instead of H2 and wire Flyway
- [X] Adjust API endpoints to require authentication tokens active for users
- [X] Implement authorization for different user roles (with Spring AOP)
- [ ] Add DB Unit for integration tests
- [ ] Add credits for users which will be used when they consume API
- [ ] Add wiremock to enable integration tests for **/quotes** endpoints
- [ ] Complete test coverage
- [ ] Add Swagger Validator for endpoints that require message body
- [ ] Add a sandbox profile that substitutes CoinMarketCap functionality with WireMock
- [ ] Add caching mechanism for CoinMarketCap requests.  
- [ ] Add a connection retry mechanism
- [ ] Migrate to Spring Security
- [ ] Migrate to PostgreSQL


<a name="recommendation"><a>
## 7. Recommended Links
#### Project Lombok
* https://www.baeldung.com/intro-to-project-lombok

Also, you need to install the InteliJ plugin for lombok, which will make the IDE understand the annotations and allow you to use
getters and setters in code completion

#### Spring Framework Web MVC
* https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/web.html#spring-web

#### Writing your first Rest Controller
* https://www.baeldung.com/building-a-restful-web-service-with-spring-and-java-based-configuration
* https://www.baeldung.com/spring-request-response-body

#### Error Handling in REST
* https://www.baeldung.com/exception-handling-for-rest-with-spring

#### Jackson 
* http://tutorials.jenkov.com/java-json/index.html
* https://www.baeldung.com/jackson-annotations
* https://www.baeldung.com/jackson-ignore-properties-on-serialization
* https://www.baeldung.com/jackson-ignore-null-fields
* https://www.baeldung.com/jackson-map

#### Entity to DTO conversion 
* https://www.baeldung.com/entity-to-and-from-dto-for-a-java-spring-application

#### MapStruct 
* https://www.baeldung.com/mapstruct
* http://mapstruct.org/documentation/stable/reference/html/

#### Swagger, Open API, Documenting Endpoints
* https://editor.swagger.io/   
* https://www.baeldung.com/swagger-2-documentation-for-spring-rest-api
* https://swagger.io/specification/
* https://idratherbewriting.com/learnapidoc/docapis_introtoapis.html
* http://json-schema.org/understanding-json-schema/index.html

#### RestAssured 
* https://github.com/rest-assured/rest-assured/wiki/Usage
* https://www.testingexcellence.com/parse-json-response-rest-assured/

#### Junit
* https://www.baeldung.com/parameterized-tests-junit-5

#### AssertJ:
* https://joel-costigliola.github.io/assertj/assertj-core-quick-start.html
* https://www.vogella.com/tutorials/AssertJ/article.html

#### Mockito
* https://www.vogella.com/tutorials/Mockito/article.html
* https://www.baeldung.com/mockito-series
* https://www.baeldung.com/mockito-argument-matchers
* https://www.baeldung.com/spring-mock-rest-template

#### CoinMarketCap API Documentation
* https://sandbox.coinmarketcap.com/api/v1/